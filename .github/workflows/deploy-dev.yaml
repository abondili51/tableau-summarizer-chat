# description: Deploys an application to a named github environment. when a PR is opened or updated for a branch.
# adding comments for testing
name: Deploy Dev

permissions:
  contents: read
  id-token: write
  deployments: write
on:
  push:
    branches:
      - dev
      - "**"

env:
  GCP_PROJECT_ID: ai-bi-tableau-dna-dev-42deab

jobs:
  # Example application tests
  #tests:
  #  runs-on: gcp
  #  steps:
  #    - run: mytestcommand --mytestarg 1
  #      shell: bash
  
  # Converts the repository name into a kebab case safe name that can be used in DNS names and container names.
  repo-name:
    runs-on: gcp
    outputs:
      safeRepoName: ${{steps.kebabcase.outputs.kebabRepository}}
    steps:
      - id: kebabcase
        uses: gmi-actions/kebabcase@v1

  # Builds backend container image
  build-backend-container:
    needs:
    - repo-name
    # - tests
    uses: gmi-actions/build-container/.github/workflows/build-container.yml@v1
    with:
      container_name: ${{ needs.repo-name.outputs.safeRepoName }}-backend
      dockerfile: backend/Dockerfile
      dockerfile_context: ./
    secrets: inherit

  # Builds frontend container image
  build-frontend-container:
    needs:
    - repo-name
    # - tests
    uses: gmi-actions/build-container/.github/workflows/build-container.yml@v1
    with:
      container_name: ${{ needs.repo-name.outputs.safeRepoName }}-frontend
      dockerfile: frontend/Dockerfile
      dockerfile_context: ./
    secrets: inherit
  
  # Deploys both backend and frontend as a single application
  dev-deploy:
    # Ignore dependabot PR's note only works from on: pull_request events. Switch to github.ref_name for pushes.
    if: (!startsWith(github.head_ref, 'dependabot'))    
    environment: dev # CHANGE ME TO YOUR DESIRED ENVIRONMENT NAME!!!    
    needs:
      - build-backend-container
      - build-frontend-container
      - repo-name
    runs-on: gcp
    outputs:
      clusterMatrix: ${{steps.deploy.outputs.clusterMatrix}}
    steps:
    - uses: actions/checkout@v4 # Checkout is required to pull the correct catalog-info-yaml
    - name: deploy application
      id: deploy
      uses: gmi-actions/deployK8sApplication@v1 
      with:
        kubeconfig: ${{secrets.K8S_DEPLOY_KUBECONFIG}}
        app_env: dev # Kube Namespace ENV Optional, More than likely this will match your Deploy Environment.
        cluster_env: nonprod
        helm: |
          releaseName: "${{ needs.repo-name.outputs.safeRepoName }}-red"
          valueFiles: ["values-dev.yaml", "values-dev-backend.yaml", "values-dev-frontend.yaml"]
        # Multi-container deployment with backend and frontend
        values: |
          # Backend container configuration
          backend:
            enabled: true
            image:
              repository: ${{needs.build-backend-container.outputs.container_registry}}/${{needs.build-backend-container.outputs.container_name}}
              tag: ${{needs.build-backend-container.outputs.container_tag}}
              containerPort: 8000
            service:
              port: 8000
              targetPort: 8000
            extraEnvs:
              GOOGLE_CLOUD_PROJECT: "ai-bi-tableau-dna-dev-42deab"
              GOOGLE_CLOUD_LOCATION: "us-central1"
              PORT: "8000"
              ENVIRONMENT: "development"
          
          # Frontend container configuration
          frontend:
            enabled: true
            image:
              repository: ${{needs.build-frontend-container.outputs.container_registry}}/${{needs.build-frontend-container.outputs.container_name}}
              tag: ${{needs.build-frontend-container.outputs.container_tag}}
              containerPort: 8080
            service:
              port: 8080
              targetPort: 8080
            extraEnvs:
              FRONTEND_URL: "https://${{ needs.repo-name.outputs.safeRepoName }}-dev.k8s.genmills.com"
              VITE_API_URL: "https://${{ needs.repo-name.outputs.safeRepoName }}-dev.k8s.genmills.com"
              VITE_CHAT_AGENT_URL: "https://tableau-ai-bi-dev.k8s.genmills.com"

          # Shared configuration
          podLabels:
            admission.datadoghq.com/enabled: "true"
            tags.datadoghq.com/env: "development"
            tags.datadoghq.com/service: "${{ github.event.repository.name }}"
            tags.datadoghq.com/version: "${{needs.build-backend-container.outputs.container_tag}}"
          serviceAccount:
            annotations:
              iam.gke.io/gcp-service-account: wi-ai-bi-summarization@ai-bi-tableau-dna-dev-42deab.iam.gserviceaccount.com
          podAnnotations:
            admission.datadoghq.com/python-lib.version: "v3.17.0"
          istio:
            enabled: true
            hosts:
              - "${{ needs.repo-name.outputs.safeRepoName }}-dev.k8s.genmills.com"

  # Deploys your application to the cluster(S) by asking argocd in the cluster to syncronize with your git repository
  dev-sync:
    # Ignore dependabot PR's note only works from on: pull_request events. Switch to github.ref_name for pushes.
    if: (!startsWith(github.head_ref, 'dependabot'))
    uses: gmi-actions/deployK8sApplication/.github/workflows/sync.yml@v1
    needs: 
      - dev-deploy      
    with:
      matrix: ${{ needs.dev-deploy.outputs.clusterMatrix }}
      environment: dev # CHANGE ME TO YOUR DESIRED ENVIRONMENT NAME!!!
    secrets: inherit

  # Example QA deployment
  # # Deploys your application to k8s-applications repository
  # qa-deploy:
  #   # Ignore dependabot PR's note only works from on: pull_request events. Switch to github.ref_name for pushes.
  #   if: (!startsWith(github.head_ref, 'dependabot'))
  #   environment: qa # CHANGE ME TO YOUR DESIRED ENVIRONMENT NAME!!!
  #   # controls what jobs this job needs to wait form commenting out dev-sync would result in dev and qa deploying in parallel
  #   needs: 
  #     - build-container
  #     - dev-sync
  #   runs-on: gcp
  #   outputs:
  #     clusterMatrix: ${{steps.deploy.outputs.clusterMatrix}}
  #   steps:
  #   - name: deploy
  #     id: deploy
  #     uses: gmi-actions/deployK8sApplication@v1 
  #     with:
  #       kubeconfig: ${{secrets.K8S_DEPLOY_KUBECONFIG}}
  #       app_env: qa # Kube Namespace ENV Optional, More than likely this will match your Deploy Environment.
  #       cluster_env: nonprod
  #       # These are your HELM values file overrides. The below contains defaults most projects will use. Do not forget to set your env_name Var in your environment
  #       values: | 
  #         image: 
  #           repository: ${{needs.build-container.outputs.container_registry}}/${{needs.build-container.outputs.container_name}}
  #           tag: ${{needs.build-container.outputs.container_tag}}
  #         istio:
  #           # Don't forget to setup your environment with Variables. This example uses a github Environment specific Variable.
  #           hosts:
  #             - ${{ github.event.repository.name }}-${{vars.env_name}}.k8s.genmills.com

  # # Deploys your application to the cluster(S) by asking argocd in the cluster to syncronize with your git repository
  # sync:
  #   # Ignore dependabot PR's note only works from on: pull_request events. Switch to github.ref_name for pushes.
  #   if: (!startsWith(github.head_ref, 'dependabot'))
  #   uses: gmi-actions/deployK8sApplication/.github/workflows/sync.yml@v1
  #   needs: qa-deploy
  #   with:
  #     matrix: ${{ needs.qa-deploy.outputs.clusterMatrix }}
  #     environment: dev # CHANGE ME TO YOUR DESIRED ENVIRONMENT NAME!!!
  #   secrets: inherit
